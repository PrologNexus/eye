@prefix list: <http://www.w3.org/2000/10/swap/list#>.
@prefix log: <http://www.w3.org/2000/10/swap/log#>.
@prefix rule: <http://www.w3.org/2000/10/swap/rule#>.
@prefix : <http://example.org/ns#>.

# sample data from RubenD
_:b1 :data (
    (_:b2 :package (
        (_:b3 :content (
            (:a :b _:c)
            (_:b4 :package (
                (_:b5 :content (
                    (:u :v _:w)
                    (_:b6 :package (
                        (_:b7 :content (
                            (:x :y _:z)
                        ))
                        (_:b7 :usable_until :yesterday)
                    ))
                    (_:b6 :tag :invalid)
                ))
                (_:b5 :usable_until :tomorrow)
                (_:b5 :p :o)
            ))
            (_:b4 :tag :valid)
        ))
        (_:b3 :usable_until :next_week)
    ))
    (_:b2 :tag :valid)
).

# the logic for unpack using backward rules
:unpack_rule1 a rule:BackwardRule;
    rule:vars ();
    rule:conclusion (
        (() :unpackLott ())
    );
    rule:premise ().

:unpack_rule2 a rule:BackwardRule;
    rule:vars (
        _:g
        _:h
        _:f
        _:r
        _:a
        _:b
    );
    rule:conclusion (
        (_:g :unpackLott _:h)
    );
    rule:premise (
        (_:g list:firstRest (_:f _:r))
        (_:f :unpack _:a)
        (_:r :unpackLott _:b)
        ((_:a _:b) list:append _:h)
    ).

:unpack_rule3 a rule:BackwardRule;
    rule:vars (
        _:b
        _:p
        _:f
        _:a
        _:c
        _:t
    );
    rule:conclusion (
        ((_:b :package _:p) :unpack _:f)
    );
    rule:premise (
        (_:p list:member (_:a :content _:c))
        (_:p list:member (_:a :usable_until _:t))
        ((:tomorrow :next_week) list:member _:t)
        (_:c :unpackLott _:f)
    ).

:unpack_rule4 a rule:BackwardRule;
    rule:vars (
        _:b
        _:p
        _:a
        _:c
        _:t
    );
    rule:conclusion (
        ((_:b :package _:p) :unpack ())
    );
    rule:premise (
        (_:p list:member (_:a :content _:c))
        (_:p list:member (_:a :usable_until _:t))
        ((:yesterday :last_week) list:member _:t)
    ).

:unpack_rule5 a rule:BackwardRule;
    rule:vars (
        _:b
        _:p
    );
    rule:conclusion (
        ((_:b :tag _:p) :unpack ())
    );
    rule:premise ().

:unpack_rule6 a rule:BackwardRule;
    rule:vars (
        _:g
        _:a
        _:p
        _:b
        _:q
    );
    rule:conclusion (
        (_:g :unpack (_:g))
    );
    rule:premise (
        ((_:g) list:notMember (_:a :package _:p))
        ((_:g) list:notMember (_:b :tag _:q))
    ).

# unpack the triples that are usable in the future
:unpack_query a rule:QueryRule;
    rule:vars (
        _:b
        _:g
        _:m
    );
    rule:premise (
        (_:b :data _:g)
        (_:g :unpackLott _:m)
    );
    rule:conclusion _:m.
